# kafka

## kafka特点

1. 支持单分区级别消息顺序性
1. 持久化
1. 事务消息
1. 支持广播消息

> 不支持延迟队列、优先级队列、消息重试

## 消息送达语义

* At most once：消息发送或消费至多一次
* At least once：消息发送或消费至少一次
* Exactly once：消息恰好只发送一次或消费一次

Kafka默认的`Producer`消息送达语义是 `At least once` ，也就是至少投递一次，保证消息不丢失。

### 消息重复和消息幂等

大多数云消息队列 Kafka 版消费的语义是at least once, 但是这样的消费语义就无法保证消息不重复。
在出现网络问题、客户端重启时，均有可能造成少量重复消息，此时应用消费端如果对消息重复比较敏感（例如订单交易类），则应该做消息幂等。

常用做法是：

1. 发送消息时，传入key作为唯一流水号ID。
1. 消费消息时，判断key是否已经消费过，如果已经被消费，则忽略，如果没消费过，则消费一次。
1. 如果应用本身对少量消息重复不敏感，则不需要做此类幂等检查。

### 消息失败

当消费者拿到某条消息后执行逻辑失败，例如应用程序出现故障，导致消息处理失败，就需要人工干预，一般的有两种处理方式：

1. 失败后再次尝试执行消费逻辑，这种方式可能造成消息阻塞，无法向前推进业务，造成消息堆积
1. 消息队列处理失败后推送到相应的服务，或者消息（例如创建一个Topic专门存储失败消息），然后定时检查失败消息，或发送到系统报警进行人工处理

## 应用场景

#### 1. 异步处理

场景说明：用户注册后，需要发送注册邮件和注册短信。传统做法有两种：1.串行化，2.并行处理

1. 串行化

    ![用户注册串行化](https://iscod.github.io/images/kafka1.png)

1. 并行处理

    ![用户注册并行处理](https://iscod.github.io/images/kafka2.png)

    引入消息队列，对非必须逻辑进行异步处理。改造后的架构如下：

1. 消息队列

    ![用户注册消息队列](https://iscod.github.io/images/kafka3.png)

    可以看到，引入消息队列将非必须的业务逻辑，进行异步处理后。用户的响应时间仅仅相当于是注册信息写入数据库的时间。系统的吞吐量比串行提高了3倍，比并行提高了2倍

#### 2. 应用解耦

场景说明: 用户下单后，订单系统需要通知库存系统、积分系统、物流系统等。传统做法是，订单系统调取库存等系统的API。

![传统模式用户下单](https://iscod.github.io/images/kafka4.png)

传统模式的缺点是，如果库存系统出现异常无法访问，则订单扣减库存失败，从而导致订单失败，订单系统与库存系统高度耦合

如何解决上面的问题呢？引入消息队列后的系统架构如下：

![引入消息队列用户下单](https://iscod.github.io/images/kafka5.png)

订单系统: 用户下单后，订单系统完成持久化，将消息写入消息队列，返回用户订单下单成功
库存系统: 订阅下单消息，采用拉/推送方式，获取订单信息，库存系统根据订单信息，进行库存操作

假如：在下单时库存系统不能正常使用。也不影响正常下单，因为下单后，订单系统写入消息队列就不再关心其他的后续操作了。实现订单系统与库存系统的应用解耦

#### 3. 流量削峰

流量削峰也是消息队列中的常用场景，一般在秒杀或团抢活动中使用广泛。

应用场景：秒杀活动，一般会因为流量过大，导致流量暴增，应用挂掉。为解决这个问题，一般需要在应用前端加入消息队列。

![流量削峰](https://iscod.github.io/images/kafka6.png)

用户的请求，服务器接收后，首先写入消息队列。假如消息队列长度超过最大数量，则直接抛弃用户请求或跳转至错误页面。
秒杀业务根据消息队列中的请求信息，做后续处理。

#### 4. 日志同步

Kafka设计的初衷是为了应对大量日志传输场景，通过异步处理方式将日志消息同步到消息服务，再通过其它组件对日志进行实时和离线分析。
日志同步的关键部件是：日志客户端采集，Kafka消息队列，后端日志处理程序，三部分实现

![日志同步](https://iscod.github.io/images/kafka7.png)


## golang实现



* 参考
* [kafka-tencent](https://cloud.tencent.com/developer/article/1974648)
* [kafka-huawei](https://support.huaweicloud.com/productdesc-kafka/kafka-scenarios.html)
* [Kafka、RabbitMQ和RocketMQ差异](https://support.huaweicloud.com/productdesc-kafka/kafka_pd_0003.html)