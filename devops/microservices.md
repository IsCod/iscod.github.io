# 如何构建微服务

### 微服务和 SOA

> 微服务的指导原则是：通过将业务组件拆分为可相互独立部署和运行的小型服务来构建应用。服务之间的关注点分离定义为”服务边界“

### 1. 从单体开始

微服务的第一个最佳实践是：*你可能不需要这些服务*。

如果您的应用程序没有任何用户，那么在构建 MVP 时，业务需求可能会迅速发生变化。
微服务会使开销和管理应用的复杂性呈指数型增长。
因此，对于新项目而言，将所有代码和逻辑保存在一个代码库中开销会要小很多。
因为这样可以更轻松的移动应用中的不同模块。

如果对系统所需的不同服务有深入了解，微服务就能很好的发挥作用。但是如果没有明确定义应用的核心需求，微服务则很难发挥作用。
在微服务中重新定义服务交互、API和数据结构的成本相当高，因为这通常需要协调更多的灵活因素。我的建议是，在收集到足够的用户反馈且有足够的信心掌握客户的基本需求并为之进行规划前，尽量让一切都保持简单。

需要注意的是：单体式构建可能会导致代码复杂性立马加剧，后期难以分解成更小的部分。因此，最好能确定清晰的模块，以便后续可将这些模块从整体中提取出来。

### 2. 以正确的方式组织团队

到目前为止，构建微服务似乎主要是一项技术工作。您需要将代码库分为多个服务，实现正确的模式以允许优雅降级，并从网络问题中恢复，处理数据一致性，监控负载均衡等。

但最重要且容易忽视的一点是，您需要重构团队的组织方式。

`康威定律`是真实存在，并且适用所有类型的团队。如果您的软件团队由一个后端团队、一个前端团队、一个运营团队组成，这个软件团队将提供独立的前端和后端单体，而这些单体被扔给运营团队随后投入生产（大部分组织结构都是这样）。此类团队结构并不适合微服务，因为每项服务都应被视为一个自己的产品，需要独立于其他服务进行交付。

相反，您应该创建规模较小的 DevOps 团队，这些团队具备所有开发和维护的能力以满足他们所负责的服务。
一个灵感来自于 Amazon 的 ”you build, you run it“ 概念，开发团队应该对生产中的软件承担全部责任。
以此方式组织您的团队大有益处。首先，开发人员可以更好的理解他们的代码在生产环境中所产生的影响，这有助于他们开发出更好的版本，并降低客户发现问题的风险。其次，部署成为每个团队的第二天性，因为他们会共同改进代码，并实现部署管道的自动化。

团队负责他们构建的软件的所有方面，包括 24/7 全天候运行软件。
这种级别的责任下放绝对不是常态，但确实能看到越来越多的公司将责任推给开发团队。Netflix 是另一个采用这种精神的组织[11]。每天凌晨 3 点被寻呼机叫醒无疑是在编写代码时关注质量的强大动力。这些想法与传统的集中式治理模式相距甚远。

> 微服务团队有多大？亚马逊有一个两个披萨团队的概念（即整个团队可以吃两个披萨）这意味着不超过十二个人。


### 3. 拆分单体式结构，构建微服务架构

确定服务的边界，并弄清楚如何重建团队后，您就可以着手拆分单体式架构，以便构建微服务。在此阶段您需要关注一下要点：

*使用RESTfulAPI简化服务之间的通信*

*将数据划分为带边界的上下文和数据域*

*构建微服务架构以应对故障*

*重视监控以简化微服务测试*

*采用持续交付，减少部署摩擦*

### 4. 运行微服务不是一蹴而就

### 5. 微服务架构设计

    * 聚合器微服务设计模式
    * 代理微服务设计模式
    * 链式微服务设计模式
    * 分支微服务设计模式
    * 异步消息传递微服务设计模式


* 参考
    * [microservices](https://premium.microservices.io/big-decisions-should-you-migrate-your-monolith-to-microservices-part-1/)
    * [building-microservices](https://www.atlassian.com/zh/microservices/microservices-architecture/building-microservices)
    * [Martin Fowler Microservices](https://martinfowler.com/articles/microservices.html)
    * [微服务定义](https://www.bookstack.cn/read/learning-microservice/definition-Martin-Fowler-microservices.md)
