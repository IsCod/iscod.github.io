# REDIS限流器

## INCR

- 将key中的存储的数字值增加一。
- 如果key不存在那么初始化为0，然后在执行INCR操作
- 如果值包含错误的类型，或字符串类型的值不能表示为数字，那么返回一个错误。

## 计数器

计数器是 Redis 的原子性自增操作可实现的最直观的模式了，它的想法相当简单：每当某个操作发生时，向 Redis 发送一个 INCR 命令。

比如在一个 web 应用程序中，如果想知道用户在一年中每天的点击量，那么只要将用户 ID 以及相关的日期信息作为键，并在每次用户点击页面时，执行一次自增操作即可。

比如用户名是 peter ，点击时间是 2012 年 3 月 22 日，那么执行命令
```sh
$ INCR peter::2012.3.22
```

可以用以下几种方式扩展这个简单的模式：

- 可以通过组合使用 INCR 和 EXPIRE ，来达到只在规定的生存时间内进行计数(counting)的目的。
- 客户端可以通过使用 GETSET 命令原子性地获取计数器的当前值并将计数器清零，更多信息请参考 GETSET 命令。
- 使用其他自增/自减操作，比如 DECR 和 INCRBY ，用户可以通过执行不同的操作增加或减少计数器的值，比如在游戏中的记分器就可能用到这些命令。

## 限速器

限速器是特殊化的计算器，它用于限制一个操作可以被执行的速率(rate)。

限速器的经典用法是限制公开的API的请求次数，以下是一个限速器时间实例，它将API的最大请求限制在每个IP地址每秒钟十个之内。

```php
<?php
  $ip = get_api_ip();//获取用户ip函数 
  $key = 'SECOND_REQUERY_NUM:' . $ip;
  $requery_num = $redis->lLen($key);
  if ($requery_num > 10) {
      die('Too many requey second');
  }
if (!$redis->existes($key)) {
  $redis->rPush($key, $ip);
  $redis->expire($key, 1);
}
  $redis->rPushx($key, $ip);
  echo 'ok';
?>
```

限速器使用列表结构作为容器,$redis->lLen()检查列表中记录的访问次数，第二个if语句用于第一次访问时，执行计数和创建列表，并且设置过期时间，最后的$redis->rPushx在后续的计数中进行增加操作。